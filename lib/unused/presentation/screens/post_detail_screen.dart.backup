import 'dart:io';
import 'dart:async';
import 'dart:ui' as ui;
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:provider/provider.dart';
import 'package:url_launcher/url_launcher.dart';
import 'package:flutter_linkify/flutter_linkify.dart';
import 'package:cached_network_image/cached_network_image.dart';
import 'package:flutter_staggered_grid_view/flutter_staggered_grid_view.dart';
import 'package:audioplayers/audioplayers.dart';
import 'package:permission_handler/permission_handler.dart';
import 'package:path_provider/path_provider.dart';
import 'package:dio/dio.dart';
import 'package:share_plus/share_plus.dart';
import 'package:html/parser.dart' as html_parser;
import 'package:flutter_inappwebview/flutter_inappwebview.dart';

import '../../domain/entities/post.dart';
import '../../domain/entities/api_source.dart';
import '../../domain/models/post_media.dart';
import '../providers/posts_provider.dart';
import '../providers/comments_provider.dart';
import '../providers/tag_filter_provider.dart';
import '../providers/download_provider.dart';
import '../theme/app_theme.dart';
import '../services/media_resolver_service.dart';
import '../controllers/audio_controller.dart';
import '../utils/media_preview_resolver.dart';
import 'fullscreen_media_viewer.dart';
import 'video_player_screen.dart';
import 'download_manager_screen.dart';
import '../widgets/comments_bottom_sheet.dart';
import '../widgets/video_webview.dart';
import '../services/custom_tabs_service.dart';

class PostDetailScreen extends StatefulWidget {
  final Post post;
  final ApiSource apiSource;
  final bool isFromSavedPosts;

  const PostDetailScreen({
    super.key, 
    required this.post, 
    required this.apiSource,
    this.isFromSavedPosts = false,
  });

  @override
  State<PostDetailScreen> createState() => _PostDetailScreenState();
}

class _PostDetailScreenState extends State<PostDetailScreen> 
    with TickerProviderStateMixin {
  
  final ScrollController _scrollController = ScrollController();
  late TabController _tabController;
  
  bool _showFullText = false;
  int _currentMediaIndex = 0;
  bool _isLoading = false;
  String? _error;
  bool _showAllMedia = false;
  
  // ‚úÖ REFACTORED: Use AudioController instead of direct AudioPlayer
  late AudioController _audioController;
  
  Post? _fullPost;

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 2, vsync: this);
    
    // ‚úÖ REFACTORED: Initialize AudioController
    _audioController = AudioController();
    
    // DEBUG: Print post information
    print('=== DEBUG: POST INFORMATION ===');
    print('Post ID: ${widget.post.id}');
    print('Post title: ${widget.post.title}');
    print('Post content length: ${widget.post.content.length}');
    print('Post content preview: ${widget.post.content.length > 100 ? widget.post.content.substring(0, 100) : widget.post.content}');
    print('Post tags count: ${widget.post.tags.length}');
    print('Post tags: ${widget.post.tags}');
    print('=== END POST DEBUG ===');
    
    // Preload comments for immediate preview
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _preloadComments();
    });
    
    // Load full post data only if not from saved posts
    if (!widget.isFromSavedPosts) {
      _loadFullPost();
    } else {
      // For saved posts, use the post directly as it's already complete
      setState(() {
        _fullPost = widget.post;
        _isLoading = false;
      });
    }
  }

  @override
  void dispose() {
    // ‚úÖ REFACTORED: Dispose AudioController
    _audioController.dispose();
    
    // ‚úÖ SIMPLE DISPOSAL - No complex cache cleanup like broken2
    _tabController.dispose();
    _scrollController.dispose();
    super.dispose();
  }

  /// Preload comments for immediate preview
  void _preloadComments() {
    print('üîç DEBUG: Preloading comments for postId: ${widget.post.id}, service: ${widget.post.service}, creatorId: ${widget.post.user}');
    final commentsProvider = context.read<CommentsProvider>();
    commentsProvider.loadComments(
      widget.post.id,
      widget.post.service,
      widget.post.user,
    );
  }

  /// Load full post data from single post API
  Future<void> _loadFullPost() async {
    setState(() {
      _isLoading = true;
      _error = null;
    });

    try {
      final postsProvider = context.read<PostsProvider>();
      await postsProvider.loadSinglePost(
        widget.post.id,
        widget.post.service,
        widget.post.user,
      );
      
      setState(() {
        _fullPost = widget.post; // For now, use original post
        _isLoading = false;
      });
      
      // DEBUG: Print full post information
      print('=== DEBUG: FULL POST INFORMATION ===');
      print('Full post content length: ${_fullPost?.content.length}');
      print('Full post content preview: ${_fullPost?.content.length != null && _fullPost!.content.length > 100 ? _fullPost!.content.substring(0, 100) : _fullPost?.content}');
      print('Full post tags count: ${_fullPost?.tags.length}');
      print('Full post tags: ${_fullPost?.tags}');
      print('=== END FULL POST DEBUG ===');
      
    } catch (e) {
      setState(() {
        _error = e.toString();
        _fullPost = widget.post; // Fallback to original post
      });
      
      print('=== DEBUG: LOAD FULL POST ERROR ===');
      print('Error: $e');
      print('=== END ERROR DEBUG ===');
    }
  }

  /// Get current post (full post if available, otherwise original post)
  Post get _currentPost => _fullPost ?? widget.post;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppTheme.getBackgroundColor(context),
      appBar: AppBar(
        title: Text(
          widget.apiSource == ApiSource.kemono ? 'Kemono' : 'Coomer',
          style: AppTheme.getTitleStyle(context).copyWith(
            color: AppTheme.getOnBackgroundColor(context),
          ),
        ),
        backgroundColor: AppTheme.getSurfaceColor(context),
        foregroundColor: AppTheme.getOnSurfaceColor(context),
        elevation: 0,
        actions: [
          // Download Button
          IconButton(
            icon: Icon(
              Icons.download,
              color: AppTheme.getOnSurfaceColor(context),
            ),
            onPressed: _downloadAllFiles,
            tooltip: 'Download All',
          ),
          
          // Share Button
          IconButton(
            icon: Icon(
              Icons.share,
              color: AppTheme.getOnBackgroundColor(context),
            ),
            onPressed: _sharePost,
          ),
        ],
      ),
      body: _isLoading 
          ? const Center(
              child: CircularProgressIndicator(
                color: AppTheme.primaryColor,
              ),
            )
          : _error != null
              ? Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(
                        Icons.error_outline,
                        size: 64,
                        color: AppTheme.errorColor,
                      ),
                      const SizedBox(height: 16),
                      Text(
                        'Error loading post',
                        style: AppTheme.titleStyle.copyWith(
                          color: AppTheme.errorColor,
                        ),
                      ),
                      const SizedBox(height: 8),
                      Text(
                        _error!,
                        style: AppTheme.captionStyle.copyWith(
                          color: AppTheme.secondaryTextColor,
                        ),
                        textAlign: TextAlign.center,
                      ),
                      const SizedBox(height: 16),
                      ElevatedButton(
                        onPressed: _loadFullPost,
                        child: const Text('Retry'),
                      ),
                    ],
                  ),
                )
              : SingleChildScrollView(
                  controller: _scrollController,
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      // Creator Header
                      _buildCreatorHeader(),
                      
                      // ‚úÖ IMAGES SECTION (Images only) - Dynamic sizing
                      _buildImagesSection(),
                      
                      // ‚úÖ VIDEOS SECTION (Videos only with WebView)
                      _buildVideosSection(),
                      
                      // AUDIO SECTION (Audio files only)
                      _buildAudioSection(),
                      
                      // DOWNLOAD LINKS SECTION
                      _buildDownloadLinksSection(),
                      
                      // Post Content (Text with Linkify + Dedicated Links)
                      _buildPostContent(),
                      
                      // Tags (Navigation)
                      if (_currentPost.tags.isNotEmpty) _buildTagsSection(),
                      
                      // Comments Section (Fixed display)
                      _buildCommentsSection(),
                      
                      // Bottom padding
                      const SizedBox(height: 32),
                    ],
                  ),
                ),
    );
  }

  /// Build Creator Header - Minimal & Clean
  Widget _buildCreatorHeader() {
    return Container(
      padding: const EdgeInsets.all(AppTheme.mdPadding),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Creator Name + Service Badge
          Row(
            children: [
              // Creator Name (Tappable)
              GestureDetector(
                onTap: () {
                  ScaffoldMessenger.of(context).showSnackBar(
                    SnackBar(content: Text('Creator: ${_currentPost.user}')),
                  );
                },
                child: Text(
                  _currentPost.user,
                  style: AppTheme.titleStyle.copyWith(
                    color: AppTheme.primaryColor,
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
              const SizedBox(width: 8),
              // Service Badge
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                decoration: BoxDecoration(
                  color: _getServiceColor().withOpacity(0.1),
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(
                    color: _getServiceColor().withOpacity(0.3),
                    width: 1,
                  ),
                ),
                child: Text(
                  _getServiceDisplayName(),
                  style: TextStyle(
                    color: _getServiceColor(),
                    fontSize: 10,
                    fontWeight: FontWeight.w500,
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 8),
          
          // Post Title (2-3 lines max)
          if (_currentPost.title.isNotEmpty)
            Text(
              _currentPost.title,
              style: AppTheme.titleStyle.copyWith(
                color: AppTheme.getOnBackgroundColor(context),
                fontSize: 18,
                fontWeight: FontWeight.w600,
                height: 1.2,
              ),
              maxLines: 3,
              overflow: TextOverflow.ellipsis,
            ),
          
          // Date
          const SizedBox(height: 4),
          Text(
            _formatDate(_currentPost.published),
            style: AppTheme.bodyStyle.copyWith(
              color: AppTheme.secondaryTextColor,
              fontSize: 12,
            ),
          ),
        ],
      ),
    );
  }

  /// ‚úÖ REFACTORED: Build Images Section using MediaResolverService
  Widget _buildImagesSection() {
    final imageItems = MediaResolverService.getImages(_currentPost);
    
    if (imageItems.isEmpty) {
      return const SizedBox.shrink();
    }

    return Container(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Images section header - Light Mode Support
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
            decoration: BoxDecoration(
              color: Theme.of(context).brightness == Brightness.dark 
                  ? Colors.blue.withOpacity(0.1)
                  : Colors.blue.withOpacity(0.05),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(
                color: Theme.of(context).brightness == Brightness.dark
                    ? Colors.blue.withOpacity(0.2)
                    : Colors.blue.withOpacity(0.1),
                width: 1,
              ),
            ),
            child: Row(
              children: [
                Icon(
                  Icons.image, 
                  size: 20, 
                  color: Theme.of(context).brightness == Brightness.dark
                      ? Colors.blue
                      : Colors.blue.shade700,
                ),
                const SizedBox(width: 8),
                Text(
                  'Images (${imageItems.length})',
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white
                        : Colors.grey.shade800,
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(height: 16),
          
          // Images grid
          _buildImagesGrid(imageItems),
        ],
      ),
    );
  }

  /// ‚úÖ REFACTORED: Build Images Grid using PostMedia
  Widget _buildImagesGrid(List<PostMedia> imageItems) {
    return MasonryGridView.count(
      shrinkWrap: true,
      physics: const NeverScrollableScrollPhysics(),
      crossAxisCount: 2,
      mainAxisSpacing: 8,
      crossAxisSpacing: 8,
      itemCount: imageItems.length,
      itemBuilder: (context, index) {
        final imageItem = imageItems[index];
        
        // ‚úÖ DYNAMIC: Calculate aspect ratio based on image dimensions
        double aspectRatio = 1.0; // Default square
        
        // Try to get aspect ratio from filename or use dynamic height
        final fileName = imageItem.name.toLowerCase();
        if (fileName.contains('portrait') || fileName.contains('vertical') || fileName.contains('tall')) {
          aspectRatio = 0.7; // Taller images
        } else if (fileName.contains('landscape') || fileName.contains('wide') || fileName.contains('horizontal')) {
          aspectRatio = 1.5; // Wider images
        } else if (fileName.contains('panorama') || fileName.contains('wide')) {
          aspectRatio = 2.0; // Very wide images
        }
        
        // Calculate dynamic height based on aspect ratio
        double dynamicHeight = 200;
        if (aspectRatio < 1.0) {
          dynamicHeight = 280; // Taller
        } else if (aspectRatio > 1.3) {
          dynamicHeight = 150; // Wider
        }
        
        return GestureDetector(
          onTap: () => _openImageFullscreen(imageItem, index),
          child: Container(
            height: dynamicHeight,
            decoration: BoxDecoration(
              color: Theme.of(context).colorScheme.surface,
              borderRadius: BorderRadius.circular(8),
              border: Border.all(color: Colors.grey.withOpacity(0.2)),
            ),
            child: ClipRRect(
              borderRadius: BorderRadius.circular(8),
              child: Stack(
                children: [
                  // ‚úÖ DYNAMIC: Image with proper aspect ratio
                  CachedNetworkImage(
                    imageUrl: imageItem.thumbnail ?? imageItem.url,
                    fit: BoxFit.cover,
                    width: double.infinity,
                    height: double.infinity,
                    placeholder: (context, url) => Container(
                      color: Theme.of(context).brightness == Brightness.dark 
                          ? Colors.grey[800]
                          : Colors.grey[300],
                      child: const Center(
                        child: CircularProgressIndicator(strokeWidth: 2),
                      ),
                    ),
                    errorWidget: (context, url, error) => Container(
                      color: Theme.of(context).brightness == Brightness.dark 
                          ? Colors.grey[800]
                          : Colors.grey[300],
                      child: Icon(
                        Icons.broken_image, 
                        color: Theme.of(context).brightness == Brightness.dark
                            ? Colors.grey
                            : Colors.grey[600],
                      ),
                    ),
                  ),
                  
                  // ‚úÖ ENHANCED: Hover effect for better UX - Light Mode Support
                  Positioned.fill(
                    child: Container(
                      decoration: BoxDecoration(
                        borderRadius: BorderRadius.circular(8),
                        gradient: LinearGradient(
                          begin: Alignment.topCenter,
                          end: Alignment.bottomCenter,
                          colors: [
                            Colors.transparent,
                            Theme.of(context).brightness == Brightness.dark
                                ? Colors.black.withOpacity(0.1)
                                : Colors.black.withOpacity(0.05),
                          ],
                        ),
                      ),
                      child: Material(
                        color: Colors.transparent,
                        child: InkWell(
                          borderRadius: BorderRadius.circular(8),
                          onTap: () => _openImageFullscreen(imageItem, index),
                          child: Icon(
                            Icons.fullscreen,
                            color: Theme.of(context).brightness == Brightness.dark
                                ? Colors.white70
                                : Colors.black54,
                            size: 32,
                          ),
                        ),
                      ),
                    ),
                  ),
                  
                  // ‚úÖ NEW: Image index indicator - Light Mode Support
                  Positioned(
                    top: 8,
                    right: 8,
                    child: Container(
                      padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                      decoration: BoxDecoration(
                        color: Theme.of(context).brightness == Brightness.dark
                            ? Colors.black.withOpacity(0.6)
                            : Colors.white.withOpacity(0.8),
                        borderRadius: BorderRadius.circular(10),
                      ),
                      child: Text(
                        '${index + 1}',
                        style: TextStyle(
                          color: Theme.of(context).brightness == Brightness.dark
                              ? Colors.white
                              : Colors.black,
                          fontSize: 10,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        );
      },
    );
  }

  /// ‚úÖ REFACTORED: Open image fullscreen using PostMedia
  void _openImageFullscreen(PostMedia imageItem, int index) {
    // Get all image items for proper navigation
    final allImageItems = MediaResolverService.getImages(_currentPost);
    
    if (allImageItems.isEmpty) return;

    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => FullscreenMediaViewer(
          mediaItems: allImageItems.map((media) => {
            'type': 'image',
            'url': media.url,
            'name': media.name,
            'thumbnail_url': media.thumbnail,
          }).toList(),
          initialIndex: index,
          apiSource: widget.apiSource,
        ),
      ),
    );
  }

  /// ‚úÖ REFACTORED: Build Videos Section using MediaResolverService
  Widget _buildVideosSection() {
    final videoItems = MediaResolverService.getVideos(_currentPost);
    
    if (videoItems.isEmpty) {
      return const SizedBox.shrink();
    }

    return Container(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Videos section header - Light Mode Support
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
            decoration: BoxDecoration(
              color: Theme.of(context).brightness == Brightness.dark 
                  ? Colors.red.withOpacity(0.1)
                  : Colors.red.withOpacity(0.05),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(
                color: Theme.of(context).brightness == Brightness.dark
                    ? Colors.red.withOpacity(0.2)
                    : Colors.red.withOpacity(0.1),
                width: 1,
              ),
            ),
            child: Row(
              children: [
                Icon(
                  Icons.videocam, 
                  size: 20, 
                  color: Theme.of(context).brightness == Brightness.dark
                      ? Colors.red
                      : Colors.red.shade700,
                ),
                const SizedBox(width: 8),
                Text(
                  'Videos (${videoItems.length})',
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white
                        : Colors.grey.shade800,
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(height: 16),
          
          // Videos list
          ...videoItems.asMap().entries.map((entry) {
            final index = entry.key;
            final videoItem = entry.value;
            return Padding(
              padding: const EdgeInsets.only(bottom: 12),
              child: _buildInlineVideoPlayer(videoItem, index),
            );
          }).toList(),
        ],
      ),
    );
  }

  /// ‚úÖ REFACTORED: Build Audio Section using MediaResolverService
  Widget _buildAudioSection() {
    final audioItems = MediaResolverService.getAudios(_currentPost);
    
    if (audioItems.isEmpty) {
      return const SizedBox.shrink();
    }

    return Container(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Audio section header - Light Mode Support
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
            decoration: BoxDecoration(
              color: Theme.of(context).brightness == Brightness.dark 
                  ? Colors.purple.withOpacity(0.1)
                  : Colors.purple.withOpacity(0.05),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(
                color: Theme.of(context).brightness == Brightness.dark
                    ? Colors.purple.withOpacity(0.2)
                    : Colors.purple.withOpacity(0.1),
                width: 1,
              ),
            ),
            child: Row(
              children: [
                Icon(
                  Icons.audiotrack, 
                  size: 20, 
                  color: Theme.of(context).brightness == Brightness.dark
                      ? Colors.purple
                      : Colors.purple.shade700,
                ),
                const SizedBox(width: 8),
                Text(
                  'Audio (${audioItems.length})',
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white
                        : Colors.grey.shade800,
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(height: 16),
          
          // Audio list
          ...audioItems.asMap().entries.map((entry) {
            final index = entry.key;
            final audioItem = entry.value;
            return Padding(
              padding: const EdgeInsets.only(bottom: 12),
              child: _buildInlineAudioPlayer(audioItem, index),
            );
          }).toList(),
        ],
      ),
    );
  }

  /// ‚úÖ REFACTORED: Open image fullscreen using PostMedia
  void _openImageFullscreen(PostMedia imageItem, int index) {
    // Get all image items for proper navigation
    final allImageItems = MediaResolverService.getImages(_currentPost);
    
    if (allImageItems.isEmpty) return;

    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => FullscreenMediaViewer(
          mediaItems: allImageItems.map((media) => {
            'type': 'image',
            'url': media.url,
            'name': media.name,
            'thumbnail_url': media.thumbnail,
          }).toList(),
          initialIndex: index,
          apiSource: widget.apiSource,
        ),
      ),
    );
  }

  /// ‚úÖ REFACTORED: Build Inline Video Player using PostMedia
  Widget _buildInlineVideoPlayer(PostMedia videoItem, int index) {
    final videoUrl = videoItem.url;
    final fileName = videoItem.name;
    final fileExtension = videoItem.extension;
    
    return Container(
      decoration: BoxDecoration(
        color: Theme.of(context).colorScheme.surface,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Colors.red.withOpacity(0.3)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Video player with WebView
          Container(
            height: 200,
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(12),
              color: Colors.black,
            ),
            child: ClipRRect(
              borderRadius: BorderRadius.circular(12),
              child: VideoWebView(
                url: videoUrl,
                height: 200,
              ),
            ),
          ),
          
          // Video info and controls
          Padding(
            padding: const EdgeInsets.all(16),
            child: Row(
              children: [
                // Video icon with format indicator
                Container(
                  width: 48,
                  height: 48,
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      colors: [
                        Colors.red[700]!,
                        Colors.red[500]!,
                      ],
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                    ),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Stack(
                    alignment: Alignment.center,
                    children: [
                      const Icon(
                        Icons.videocam,
                        color: Colors.white,
                        size: 24,
                      ),
                      // Format badge
                      Positioned(
                        top: 2,
                        right: 2,
                        child: Container(
                          padding: const EdgeInsets.symmetric(horizontal: 2, vertical: 1),
                          decoration: BoxDecoration(
                            color: Colors.white.withOpacity(0.9),
                            borderRadius: BorderRadius.circular(4),
                          ),
                          child: Text(
                            fileExtension.toUpperCase(),
                            style: TextStyle(
                              color: Colors.red[700],
                              fontSize: 6,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
                
                const SizedBox(width: 16),
                
                // Video info
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      // File name - Light Mode Support
                      Text(
                        videoItem.displayName,
                        style: TextStyle(
                          color: Theme.of(context).brightness == Brightness.dark
                              ? Colors.white
                              : Colors.grey.shade800,
                          fontSize: 14,
                          fontWeight: FontWeight.w600,
                        ),
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                      ),
                      
                      const SizedBox(height: 4),
                      
                      // Video quality indicator - Light Mode Support
                      Container(
                        padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                        decoration: BoxDecoration(
                          color: Theme.of(context).brightness == Brightness.dark
                              ? Colors.red.withOpacity(0.2)
                              : Colors.red.withOpacity(0.1),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Text(
                          'Video',
                          style: TextStyle(
                            color: Theme.of(context).brightness == Brightness.dark
                                ? Colors.red
                                : Colors.red.shade700,
                            fontSize: 10,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
                
                const SizedBox(width: 16),
                
                // Action buttons
                Row(
                  children: [
                    // Fullscreen button
                    GestureDetector(
                      onTap: () => _openVideoFullscreen(videoItem),
                      child: Container(
                        width: 40,
                        height: 40,
                        decoration: BoxDecoration(
                          color: Colors.red.withOpacity(0.2),
                          shape: BoxShape.circle,
                          border: Border.all(
                            color: Colors.red.withOpacity(0.5),
                            width: 2,
                          ),
                        ),
                        child: const Icon(
                          Icons.fullscreen,
                          color: Colors.red,
                          size: 20,
                        ),
                      ),
                    ),
                    
                    const SizedBox(width: 8),
                    
                    // Download button
                    GestureDetector(
                      onTap: () => _downloadSingleMediaFile(videoItem),
                      child: Container(
                        width: 40,
                        height: 40,
                        decoration: BoxDecoration(
                          color: Colors.white.withOpacity(0.2),
                          shape: BoxShape.circle,
                          border: Border.all(
                            color: Colors.white.withOpacity(0.5),
                            width: 2,
                          ),
                        ),
                        child: const Icon(
                          Icons.download,
                          color: Colors.white70,
                          size: 20,
                        ),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  /// ‚úÖ REFACTORED: Build Inline Audio Player using PostMedia & AudioController
  Widget _buildInlineAudioPlayer(PostMedia audioItem, int index) {
    final audioUrl = audioItem.url;
    final fileName = audioItem.name;
    final fileExtension = audioItem.extension;
    
    return ChangeNotifierProvider.value(
      value: _audioController,
      child: Consumer<AudioController>(
        builder: (context, audioController, _) {
          final isCurrentlyPlaying = audioController.isPlayingUrl(audioUrl);
          
          return Container(
            decoration: BoxDecoration(
              color: Theme.of(context).colorScheme.surface,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.purple.withOpacity(0.3)),
            ),
            child: Padding(
              padding: const EdgeInsets.all(16),
              child: Row(
                children: [
                  // Audio icon with format indicator
                  Container(
                    width: 48,
                    height: 48,
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        colors: [
                          _getAudioColor(fileExtension),
                          _getAudioColor(fileExtension).withOpacity(0.8),
                        ],
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                      ),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Stack(
                      alignment: Alignment.center,
                      children: [
                        Icon(
                          isCurrentlyPlaying ? Icons.graphic_eq : Icons.audiotrack,
                          color: Colors.white,
                          size: 24,
                        ),
                        // Format badge
                        Positioned(
                          top: 2,
                          right: 2,
                          child: Container(
                            padding: const EdgeInsets.symmetric(horizontal: 2, vertical: 1),
                            decoration: BoxDecoration(
                              color: Colors.white.withOpacity(0.9),
                              borderRadius: BorderRadius.circular(4),
                            ),
                            child: Text(
                              fileExtension.toUpperCase(),
                              style: TextStyle(
                                color: _getAudioColor(fileExtension),
                                fontSize: 6,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                  
                  const SizedBox(width: 16),
                  
                  // Audio info and controls
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        // File name - Light Mode Support
                        Text(
                          audioItem.displayName,
                          style: TextStyle(
                            color: Theme.of(context).brightness == Brightness.dark
                                ? Colors.white
                                : Colors.grey.shade800,
                            fontSize: 14,
                            fontWeight: FontWeight.w600,
                          ),
                          maxLines: 1,
                          overflow: TextOverflow.ellipsis,
                        ),
                        
                        const SizedBox(height: 4),
                        
                        // Audio quality indicator - Light Mode Support
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                          decoration: BoxDecoration(
                            color: Theme.of(context).brightness == Brightness.dark
                                ? Colors.purple.withOpacity(0.2)
                                : Colors.purple.withOpacity(0.1),
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: Text(
                            _getAudioQuality(fileExtension),
                            style: TextStyle(
                              color: Theme.of(context).brightness == Brightness.dark
                                  ? Colors.purple
                                  : Colors.purple.shade700,
                              fontSize: 10,
                            ),
                          ),
                        ),
                        
                        // Progress bar with seek functionality (always visible when playing)
                        if (isCurrentlyPlaying && audioController.duration.inMilliseconds > 0) ...[
                          const SizedBox(height: 8),
                          // Interactive progress bar - Light Mode Support
                          GestureDetector(
                            onTap: () => _seekAudioPosition(audioItem, audioController),
                            child: LinearProgressIndicator(
                              value: audioController.position.inMilliseconds / audioController.duration.inMilliseconds,
                              backgroundColor: Theme.of(context).brightness == Brightness.dark
                                  ? Colors.white.withOpacity(0.2)
                                  : Colors.black.withOpacity(0.1),
                              valueColor: AlwaysStoppedAnimation<Color>(
                                Theme.of(context).brightness == Brightness.dark
                                    ? Colors.purple
                                    : Colors.purple.shade700,
                              ),
                            ),
                          ),
                          const SizedBox(height: 4),
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              Text(
                                _formatDuration(audioController.position),
                                style: TextStyle(
                                  color: Theme.of(context).brightness == Brightness.dark
                                      ? Colors.white70
                                      : Colors.black54,
                                  fontSize: 10,
                                ),
                              ),
                              Text(
                                _formatDuration(audioController.duration),
                                style: TextStyle(
                                  color: Theme.of(context).brightness == Brightness.dark
                                      ? Colors.white70
                                      : Colors.black54,
                                  fontSize: 10,
                                ),
                              ),
                            ],
                          ),
                        ],
                      ],
                    ),
                  ),
                  
                  const SizedBox(width: 16),
                  
                  // Play/Pause button with proper state
                  GestureDetector(
                    onTap: () => audioController.togglePlayback(audioUrl),
                    child: Container(
                      width: 48,
                      height: 48,
                      decoration: BoxDecoration(
                        color: Colors.purple.withOpacity(0.2),
                        shape: BoxShape.circle,
                        border: Border.all(
                          color: Colors.purple.withOpacity(0.5),
                          width: 2,
                        ),
                      ),
                      child: Icon(
                        isCurrentlyPlaying ? Icons.pause : Icons.play_arrow,
                        color: Colors.purple,
                        size: 24,
                      ),
                    ),
                  ),
                ],
              ),
            ),
          );
        },
      ),
    );
  }

  /// ‚úÖ REFACTORED: Seek audio position using AudioController
  void _seekAudioPosition(PostMedia audioItem, AudioController audioController) async {
    if (!audioController.isPlayingUrl(audioItem.url) || audioController.duration.inMilliseconds == 0) return;
    
    try {
      // Calculate seek position based on tap (simplified - seeks to middle for demo)
      final seekPosition = Duration(seconds: audioController.duration.inSeconds ~/ 2);
      await audioController.seekTo(seekPosition);
      print('üîç DEBUG: Seeked to position: ${seekPosition.inSeconds}s');
    } catch (e) {
      print('üîç DEBUG: Seek error: $e');
    }
  }

  /// ‚úÖ REFACTORED: Get audio color by format
  Color _getAudioColor(String extension) {
    switch (extension.toLowerCase()) {
      case 'mp3':
        return Colors.orange[700]!;
      case 'wav':
        return Colors.blue[700]!;
      case 'flac':
        return Colors.purple[700]!;
      case 'aac':
      case 'm4a':
        return Colors.red[700]!;
      case 'ogg':
        return Colors.green[700]!;
      default:
        return Colors.purple[700]!;
    }
  }

  /// ‚úÖ REFACTORED: Get audio quality by format
  String _getAudioQuality(String extension) {
    switch (extension.toLowerCase()) {
      case 'mp3':
        return 'Compressed';
      case 'flac':
        return 'Lossless';
      case 'wav':
        return 'Uncompressed';
      case 'aac':
      case 'm4a':
        return 'High Quality';
      case 'ogg':
        return 'Open Source';
      default:
        return 'Audio';
    }
  }

  /// ‚úÖ REFACTORED: Format duration for display
  String _formatDuration(Duration duration) {
    String twoDigits(int n) => n.toString().padLeft(2, '0');
    final minutes = twoDigits(duration.inMinutes.remainder(60));
    final seconds = twoDigits(duration.inSeconds.remainder(60));
    return '$minutes:$seconds';
  }

  /// ‚úÖ REFACTORED: Open video fullscreen using PostMedia
  void _openVideoFullscreen(PostMedia videoItem) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => VideoPlayerScreen(
          videoUrl: videoItem.url,
          videoName: videoItem.name,
          apiSource: widget.apiSource.name,
        ),
      ),
    );
  }

  /// ‚úÖ REFACTORED: Download single media file using PostMedia
  void _downloadSingleMediaFile(PostMedia mediaItem) {
    // Implement download logic here
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('Downloading: ${mediaItem.name}')),
    );
  }

  /// Build Media Section with client-side downscaling
  Widget _buildMediaSection() {
    // Collect and sort media items using MediaPreviewResolver
    final mediaItems = _collectAndSortMedia();
    
    if (mediaItems.isEmpty) {
      return const SizedBox.shrink();
    }

    // Progressive disclosure logic
    const maxPreviewItems = 6;
    final hasManyItems = mediaItems.length > maxPreviewItems;
    final displayItems = _showAllMedia 
        ? mediaItems // Show all when expanded
        : (hasManyItems 
            ? mediaItems.take(maxPreviewItems).toList()
            : mediaItems); // Show preview when collapsed

    return Container(
      padding: const EdgeInsets.all(AppTheme.mdPadding),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Modern Header with count
          _buildMediaHeader(mediaItems.length),
          const SizedBox(height: AppTheme.mdSpacing),
          
          // Media Grid with client-side downscaling
          _buildMediaGridWithDownscaling(displayItems, mediaItems.length),
          
          // Expand/Collapse button untuk post besar
          if (hasManyItems) ...[
            const SizedBox(height: AppTheme.mdSpacing),
            _buildExpandCollapseButton(mediaItems.length),
          ],
        ],
      ),
    );
  }

  /// Collect and sort media from current post (FIXED THUMBNAIL GENERATION)
  List<Map<String, dynamic>> _collectAndSortMedia() {
    final List<Map<String, dynamic>> mediaItems = [];
    
    // Process images from files using RAW PATH
    for (final file in _currentPost.file) {
      if (_isMediaFile(file.name)) {
        // BENAR: Gunakan RAW PATH untuk thumbnail
        final rawPath = file.path;
        final fullUrl = _buildFullUrl(rawPath);
        final thumbnailUrl = buildThumbnailFromRawPath(rawPath, _currentPost.service);
        
        mediaItems.add({
          'type': 'image',
          'url': fullUrl,
          'name': file.name,
          'thumbnail_url': thumbnailUrl,
        });
        
        print(' DEBUG: File - Raw path: $rawPath');
        print(' DEBUG: File - Full URL: $fullUrl');
        print(' DEBUG: File - Thumbnail URL: $thumbnailUrl');
      }
    }
    
    // Process attachments using RAW PATH
    for (final attachment in _currentPost.attachments) {
      if (attachment.path != null && _isMediaFile(attachment.name)) {
        // BENAR: Gunakan RAW PATH untuk thumbnail
        final rawPath = attachment.path!;
        final fullUrl = _buildFullUrl(rawPath);
        final thumbnailUrl = buildThumbnailFromRawPath(rawPath, _currentPost.service);
        final isVideo = attachment.name?.toLowerCase().endsWith('.mp4') == true ||
                       attachment.name?.toLowerCase().endsWith('.webm') == true ||
                       attachment.name?.toLowerCase().endsWith('.mov') == true;
        
        mediaItems.add({
          'type': isVideo ? 'video' : 'image',
          'url': fullUrl,
          'name': attachment.name ?? 'Unknown',
          'thumbnail_url': thumbnailUrl,
        });
        
        print(' DEBUG: Attachment - Raw path: $rawPath');
        print(' DEBUG: Attachment - Full URL: $fullUrl');
        print(' DEBUG: Attachment - Thumbnail URL: $thumbnailUrl');
      }
    }

    // Sort by name for consistent order
    mediaItems.sort((a, b) => (a['name'] as String).compareTo(b['name'] as String));
    
    print(' DEBUG: Total media items: ${mediaItems.length}');
    return mediaItems;
  }

  /// Check if file is a media file
  bool _isMediaFile(String? filename) {
    if (filename == null) return false;
    final name = filename.toLowerCase();
    return name.endsWith('.jpg') ||
           name.endsWith('.jpeg') ||
           name.endsWith('.png') ||
           name.endsWith('.gif') ||
           name.endsWith('.webp') ||
           name.endsWith('.mp4') ||
           name.endsWith('.webm') ||
           name.endsWith('.mov') ||
           name.endsWith('.avi') ||
           name.endsWith('.mkv');
  }

  /// Build full URL from path (SAME AS BROKEN2)
  String _buildFullUrl(String path) {
    if (path.startsWith('http')) {
      return path; // Already full URL
    }
    
    // Determine domain based on service
    String domain;
    if (_currentPost.service == 'onlyfans' || 
        _currentPost.service == 'fansly' || 
        _currentPost.service == 'candfans') {
      // Use CDN rotation for Coomer reliability
      domain = 'https://n2.coomer.st'; // Primary CDN
    } else {
      domain = 'https://kemono.cr'; // Kemono services
    }
    
    return '$domain/data$path';
  }

  /// Build thumbnail from RAW PATH (FINAL CORRECT METHOD!)
  String buildThumbnailFromRawPath(String rawPath, String service) {
    if (rawPath.isEmpty) return '';

    // Pastikan rawPath diawali '/'
    final clean = rawPath.startsWith('/') ? rawPath : '/$rawPath';
    
    print('üîç DEBUG: buildThumbnail - Input rawPath: $rawPath');
    print('üîç DEBUG: buildThumbnail - Clean path: $clean');
    print('üîç DEBUG: buildThumbnail - Service: $service');

    // Hasil akhir: thumbnail/data/xx/yy/filename.ext
    final thumbnailPath = 'thumbnail/data$clean';
    print('üîç DEBUG: buildThumbnail - Thumbnail path: $thumbnailPath');

    final thumbnailUrl = service == 'onlyfans' || service == 'fansly' || service == 'candfans'
        ? 'https://img.coomer.st/$thumbnailPath'
        : 'https://img.kemono.cr/$thumbnailPath';
        
    print('üîç DEBUG: buildThumbnail - Final thumbnail URL: $thumbnailUrl');
    return thumbnailUrl;
  }

  /// Build modern media header
  Widget _buildMediaHeader(int totalItems) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            AppTheme.primaryColor.withOpacity(0.1),
            AppTheme.primaryColor.withOpacity(0.05),
          ],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: AppTheme.primaryColor.withOpacity(0.2),
          width: 1,
        ),
      ),
      child: Row(
        children: [
          Icon(
            Icons.photo_library_outlined,
            color: AppTheme.primaryColor,
            size: 20,
          ),
          const SizedBox(width: 8),
          Text(
            'Media ($totalItems)',
            style: AppTheme.titleStyle.copyWith(
              color: AppTheme.getOnBackgroundColor(context),
              fontSize: 16,
              fontWeight: FontWeight.w600,
            ),
          ),
          const Spacer(),
          if (_isCoomerService())
            Padding(
              padding: const EdgeInsets.only(left: 8),
              child: Tooltip(
                message: 'Coomer CDN - May load slower',
                child: Icon(
                  Icons.speed,
                  color: Colors.orange.withOpacity(0.7),
                  size: 16,
                ),
              ),
            ),
        ],
      ),
    );
  }

  /// Build media grid with dynamic columns and heights
  Widget _buildMediaGridWithDownscaling(List<Map<String, dynamic>> displayItems, int totalItems) {
    final columns = _getGridColumns(displayItems.length, totalItems);
    
    return Container(
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Theme.of(context).dividerColor),
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(12),
        child: MasonryGridView.count(
          shrinkWrap: true,
          physics: const NeverScrollableScrollPhysics(),
          crossAxisCount: columns,
          mainAxisSpacing: 8,
          crossAxisSpacing: 8,
          itemCount: displayItems.length,
          itemBuilder: (context, index) {
            final mediaItem = displayItems[index];
            final isVideo = mediaItem['type'] == 'video';
            final height = _getMediaHeight(index, totalItems);
            
            return Container(
              height: height,
              decoration: BoxDecoration(
                color: Theme.of(context).colorScheme.surface,
                borderRadius: BorderRadius.circular(8),
                border: Border.all(color: Colors.grey.withOpacity(0.2)),
              ),
              child: Stack(
                fit: StackFit.expand,
                children: [
                  // Media thumbnail with client-side downscaling
                  ClipRRect(
                    borderRadius: BorderRadius.circular(8),
                    child: Container(
                      width: double.infinity,
                      height: double.infinity,
                      child: isVideo 
                          ? _buildAdvancedVideoPlaceholder(mediaItem)
                          : _buildOptimizedImage(mediaItem['url'], thumbnailUrl: mediaItem['thumbnail_url']),
                    ),
                  ),
                  
                  // Video indicator
                  if (isVideo)
                    Positioned.fill(
                      child: Container(
                        decoration: BoxDecoration(
                          color: Colors.black.withOpacity(0.3),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: const Center(
                          child: Icon(
                            Icons.play_circle_outline,
                            color: Colors.white,
                            size: 48,
                          ),
                        ),
                      ),
                    ),
                  
                  // Image number indicator
                  Positioned(
                    top: 8,
                    right: 8,
                    child: Container(
                      padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                      decoration: BoxDecoration(
                        color: Colors.black.withOpacity(0.6),
                        borderRadius: BorderRadius.circular(10),
                      ),
                      child: Text(
                        '${index + 1}',
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 10,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                    ),
                  ),
                  
                  // Tap to view overlay
                  Positioned.fill(
                    child: Material(
                      color: Colors.transparent,
                      child: InkWell(
                        borderRadius: BorderRadius.circular(8),
                        onTap: () => _openMediaItem(mediaItem, index, isVideo),
                        child: Container(
                          decoration: BoxDecoration(
                            borderRadius: BorderRadius.circular(8),
                          ),
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            );
          },
        ),
      ),
    );
  }

  /// Build advanced video placeholder
  Widget _buildAdvancedVideoPlaceholder(Map<String, dynamic> mediaItem) {
    return Container(
      decoration: BoxDecoration(
        color: Theme.of(context).colorScheme.surface,
        borderRadius: BorderRadius.circular(8),
      ),
      child: Stack(
        children: [
          // Background gradient
          Container(
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [
                  Theme.of(context).colorScheme.surface,
                  Theme.of(context).colorScheme.surfaceVariant,
                ],
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
              ),
            ),
          ),
          
          // Video icon
          Center(
            child: Icon(
              Icons.play_circle_outline,
              color: Theme.of(context).colorScheme.onSurface.withOpacity(0.7),
              size: 48,
            ),
          ),
          
          // Video info
          Positioned(
            bottom: 8,
            left: 8,
            right: 8,
            child: Row(
              children: [
                // Video badge
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                  decoration: BoxDecoration(
                    color: Theme.of(context).colorScheme.shadow.withOpacity(0.5),
                    borderRadius: BorderRadius.circular(4),
                  ),
                  child: Text(
                    'Video',
                    style: TextStyle(
                      color: Theme.of(context).colorScheme.onSurface,
                      fontSize: 10,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                ),
                const Spacer(),
                // File name
                Expanded(
                  flex: 2,
                  child: Text(
                    _getFileName(mediaItem['name'] ?? 'Video'),
                    style: TextStyle(
                      color: Theme.of(context).colorScheme.onSurface.withOpacity(0.7),
                      fontSize: 9,
                    ),
                    overflow: TextOverflow.ellipsis,
                    maxLines: 1,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  /// Build downscaled media item with dynamic aspect ratio
  Widget _buildDownscaledMediaItem(
    Map<String, dynamic> mediaItem, 
    int index, 
    bool isVideo, 
    int totalItems
  ) {
    return FutureBuilder<double>(
      future: _getImageAspectRatio(mediaItem['url']),
      builder: (context, snapshot) {
        double aspectRatio = snapshot.data ?? 1.3;
        
        // Calculate optimal height based on aspect ratio
        final screenWidth = MediaQuery.of(context).size.width;
        final columnWidth = (screenWidth - 24) / 2;
        double containerHeight = columnWidth / aspectRatio;
        
        // Limit minimum and maximum height for better UX
        containerHeight = containerHeight.clamp(120.0, 500.0);
        
        return Container(
          height: containerHeight,
          decoration: BoxDecoration(
            color: Theme.of(context).colorScheme.surface,
            borderRadius: BorderRadius.circular(8),
            border: Border.all(color: Colors.grey.withOpacity(0.2)),
          ),
          child: Stack(
            fit: StackFit.expand,
            children: [
              // Media thumbnail with client-side downscaling
              ClipRRect(
                borderRadius: BorderRadius.circular(8),
                child: Container(
                  width: double.infinity,
                  height: double.infinity,
                  child: isVideo 
                      ? MediaPreviewResolver.buildVideoPlaceholder()
                      : MediaPreviewResolver.buildDetailPostImage(
                          thumbnailUrl: mediaItem['thumbnail_url'] ?? mediaItem['url'],
                          fullUrl: mediaItem['url'],
                        ),
                ),
              ),
              
              // Video indicator
              if (isVideo)
                Positioned.fill(
                  child: Container(
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.3),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: const Center(
                      child: Icon(
                        Icons.play_circle_outline,
                        color: Colors.white,
                        size: 48,
                      ),
                    ),
                  ),
                ),
              
              // Image number indicator
              Positioned(
                top: 8,
                right: 8,
                child: Container(
                  padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                  decoration: BoxDecoration(
                    color: Colors.black.withOpacity(0.6),
                    borderRadius: BorderRadius.circular(10),
                  ),
                  child: Text(
                    '${index + 1}',
                    style: const TextStyle(
                      color: Colors.white,
                      fontSize: 10,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ),
              ),
              
              // Tap to view overlay
              Positioned.fill(
                child: Material(
                  color: Colors.transparent,
                  child: InkWell(
                    borderRadius: BorderRadius.circular(8),
                    onTap: () => _openFullscreenMediaViewer(mediaItem, index),
                    child: Container(
                      decoration: BoxDecoration(
                        borderRadius: BorderRadius.circular(8),
                      ),
                    ),
                  ),
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  /// Get image aspect ratio by analyzing URL patterns
  Future<double> _getImageAspectRatio(String imageUrl) async {
    try {
      final url = imageUrl.toLowerCase();
      
      // Analyze URL patterns for aspect ratio hints
      if (url.contains('.gif')) {
        return 1.0;
      } else if (url.contains('thumbnail') || url.contains('thumb')) {
        return 1.0;
      } else if (url.contains('banner') || url.contains('header')) {
        return 3.0;
      } else if (url.contains('portrait') || url.contains('vertical')) {
        return 0.67;
      } else if (url.contains('landscape') || url.contains('horizontal')) {
        return 1.78;
      } else if (url.contains('manga') || url.contains('comic')) {
        return 1.41;
      } else if (url.contains('webp')) {
        return 1.2;
      } else if (url.contains('wide') || url.contains('panorama')) {
        return 2.5;
      } else if (url.contains('tall') || url.contains('long')) {
        return 0.6;
      } else {
        // Default aspect ratios
        if (url.contains('.jpg') || url.contains('.jpeg')) {
          return 1.33;
        } else if (url.contains('.png')) {
          return 1.2;
        } else {
          return 1.3;
        }
      }
    } catch (_) {
      return 1.3;
    }
  }

  /// Build expand/collapse button
  Widget _buildExpandCollapseButton(int totalItems) {
    final isExpanded = _showAllMedia;
    final remainingItems = totalItems - 6;
    
    return Container(
      width: double.infinity,
      height: 50,
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [
            AppTheme.primaryColor.withOpacity(0.1),
            AppTheme.primaryColor.withOpacity(0.05),
          ],
        ),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: AppTheme.primaryColor.withOpacity(0.3),
          width: 1,
        ),
      ),
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          onTap: () => _toggleShowAllMedia(),
          borderRadius: BorderRadius.circular(12),
          child: Center(
            child: Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(
                  isExpanded ? Icons.expand_less : Icons.expand_more,
                  color: AppTheme.primaryColor,
                  size: 20,
                ),
                const SizedBox(width: 8),
                Text(
                  isExpanded 
                      ? 'Show less media'
                      : 'Show all media ($totalItems)',
                  style: AppTheme.titleStyle.copyWith(
                    color: AppTheme.primaryColor,
                    fontSize: 14,
                    fontWeight: FontWeight.w600,
                  ),
                ),
                if (!isExpanded && remainingItems > 0) ...[
                  const SizedBox(width: 8),
                  Container(
                    padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                    decoration: BoxDecoration(
                      color: AppTheme.primaryColor.withOpacity(0.2),
                      borderRadius: BorderRadius.circular(10),
                    ),
                    child: Text(
                      '+$remainingItems',
                      style: TextStyle(
                        color: AppTheme.primaryColor,
                        fontSize: 12,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                  ),
                ],
              ],
            ),
          ),
        ),
      ),
    );
  }

  /// Open fullscreen media viewer with all media items
  void _openFullscreenMediaViewer(Map<String, dynamic> mediaItem, int index) {
    // Get all media items from the post
    final allMediaItems = _collectAndSortMedia();
    
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => FullscreenMediaViewer(
          mediaItems: allMediaItems,
          initialIndex: index,
          apiSource: widget.apiSource,
        ),
      ),
    );
  }

  // [Sisanya dari kode sebelumnya tetap sama, termasuk fungsi-fungsi seperti:
  // _buildDownloadLinksSection, _buildPostContent, _buildCommentsSection,
  // _buildTagsSection, _downloadAllFiles, _downloadFile, dll.
  // Hanya update bagian yang berhubungan dengan media preview]
  
  /// Toggle show all media state
  void _toggleShowAllMedia() {
    setState(() {
      _showAllMedia = !_showAllMedia;
    });
    
    // ‚ùå HAPUS auto scroll - biarkan user kontrol sendiri
    // User mau scroll manual, tidak dipaksa
  }

  /// Clean HTML tags from content
  String _cleanHtmlContent(String content) {
    try {
      // Parse HTML and extract text
      final document = html_parser.parse(content);
      String cleanText = document.body?.text ?? content;
      
      // Clean up extra whitespace
      cleanText = cleanText.replaceAll(RegExp(r'\s+'), ' ').trim();
      
      return cleanText;
    } catch (e) {
      // Fallback to original content if parsing fails
      return content;
    }
  }

  /// Helper Methods
  bool _isCoomerService() {
    return _currentPost.service == 'onlyfans' || 
           _currentPost.service == 'fansly' || 
           _currentPost.service == 'candfans';
  }

  String _getServiceDisplayName() {
    switch (_currentPost.service.toLowerCase()) {
      case 'patreon':
        return 'Patreon';
      case 'fanbox':
        return 'Fanbox';
      case 'fantia':
        return 'Fantia';
      case 'onlyfans':
        return 'OnlyFans';
      case 'fansly':
        return 'Fansly';
      case 'candfans':
        return 'CandFans';
      default:
        return _currentPost.service.toUpperCase();
    }
  }

  Color _getServiceColor() {
    switch (_currentPost.service.toLowerCase()) {
      case 'patreon':
        return Colors.orange;
      case 'fanbox':
        return Colors.blue;
      case 'fantia':
        return Colors.purple;
      case 'onlyfans':
        return Colors.pink;
      case 'fansly':
        return Colors.teal;
      case 'candfans':
        return Colors.red;
      default:
        return AppTheme.primaryColor;
    }
  }

  String _formatDate(DateTime date) {
    final now = DateTime.now();
    final difference = now.difference(date);
    
    if (difference.inDays == 0) {
      return 'Today';
    } else if (difference.inDays == 1) {
      return 'Yesterday';
    } else if (difference.inDays < 7) {
      return '${difference.inDays} days ago';
    } else {
      return '${date.day} ${_getMonthName(date.month)} ${date.year}';
    }
  }

  String _getMonthName(int month) {
    const months = [
      'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
      'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
    ];
    return months[month - 1];
  }

  /// Build Download Links Section - Enhanced with Light Mode Support
  Widget _buildDownloadLinksSection() {
    final extractedLinks = _extractLinksFromContent();
    
    print('üîó DEBUG: Building download links section...');
    print('üîó DEBUG: Extracted links count: ${extractedLinks.length}');
    print('üîó DEBUG: Content preview: ${_currentPost.content.length > 100 ? _currentPost.content.substring(0, 100) : _currentPost.content}');
    
    if (extractedLinks.isEmpty) {
      print('üîó DEBUG: No links found, hiding section');
      return const SizedBox.shrink();
    }

    return Container(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Links section header - Light Mode Support
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [
                  Theme.of(context).brightness == Brightness.dark
                      ? Colors.green.withOpacity(0.1)
                      : Colors.green.withOpacity(0.05), // Light mode
                  Theme.of(context).brightness == Brightness.dark
                      ? Colors.green.withOpacity(0.05)
                      : Colors.green.withOpacity(0.02), // Light mode
                ],
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
              ),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(
                color: Theme.of(context).brightness == Brightness.dark
                    ? Colors.green.withOpacity(0.2)
                    : Colors.green.withOpacity(0.1), // Light mode
                width: 1,
              ),
            ),
            child: Row(
              children: [
                Icon(
                  Icons.link,
                  color: Theme.of(context).brightness == Brightness.dark
                      ? Colors.green
                      : Colors.green.shade700, // Light mode
                  size: 20,
                ),
                const SizedBox(width: 8),
                Text(
                  'Links (${extractedLinks.length})',
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.white
                        : Colors.grey.shade800, // Light mode
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(height: 16),
          
          // Links list
          ...extractedLinks.asMap().entries.map((entry) {
            final index = entry.key;
            final link = entry.value;
            return Padding(
              padding: const EdgeInsets.only(bottom: 12),
              child: Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: Theme.of(context).cardColor,
                  borderRadius: BorderRadius.circular(8),
                  border: Border.all(
                    color: Theme.of(context).brightness == Brightness.dark
                        ? Colors.grey.withOpacity(0.3)
                        : Colors.grey.withOpacity(0.2), // Light mode
                  ),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // Link URL (selectable) - Light Mode Support
                    SelectableText(
                      link,
                      style: TextStyle(
                        fontSize: 12,
                        color: Theme.of(context).brightness == Brightness.dark
                            ? Colors.grey[300]
                            : Colors.grey[700], // Light mode
                        fontFamily: 'monospace',
                      ),
                    ),
                    const SizedBox(height: 8),
                    
                    // Action buttons
                    Row(
                      children: [
                        // Copy link button
                        IconButton(
                          onPressed: () => _copyLinkToClipboard(link),
                          icon: Icon(
                            Icons.copy,
                            size: 16,
                            color: Theme.of(context).brightness == Brightness.dark
                                ? Colors.green
                                : Colors.green.shade700, // Light mode
                          ),
                          tooltip: 'Copy Link',
                          padding: EdgeInsets.zero,
                          constraints: const BoxConstraints(minWidth: 32, minHeight: 32),
                        ),
                        
                        const SizedBox(width: 8),
                        
                        // Open in browser button - Light Mode Support
                        Expanded(
                          child: ElevatedButton.icon(
                            onPressed: () => _openLinkInBrowser(link),
                            icon: const Icon(
                              Icons.open_in_new,
                              size: 16,
                            ),
                            label: const Text(
                              'Open',
                              style: TextStyle(fontSize: 12),
                            ),
                            style: ElevatedButton.styleFrom(
                              backgroundColor: Theme.of(context).brightness == Brightness.dark
                                  ? Colors.green
                                  : Colors.green.shade700, // Light mode
                              foregroundColor: Colors.white,
                              padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                              minimumSize: const Size(0, 32),
                            ),
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            );
          }).toList(),
          
          // Download all button - Light Mode Support
          const SizedBox(height: AppTheme.mdSpacing),
          Container(
            width: double.infinity,
            height: 50,
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [
                  Theme.of(context).brightness == Brightness.dark
                      ? Colors.green.withOpacity(0.1)
                      : Colors.green.withOpacity(0.05), // Light mode
                  Theme.of(context).brightness == Brightness.dark
                      ? Colors.green.withOpacity(0.05)
                      : Colors.green.withOpacity(0.02), // Light mode
                ],
              ),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(
                color: Theme.of(context).brightness == Brightness.dark
                    ? Colors.green.withOpacity(0.3)
                    : Colors.green.withOpacity(0.2), // Light mode
                width: 1,
              ),
            ),
            child: Material(
              color: Colors.transparent,
              child: InkWell(
                onTap: _downloadAllFiles,
                borderRadius: BorderRadius.circular(12),
                child: Center(
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(
                        Icons.download_for_offline,
                        color: Theme.of(context).brightness == Brightness.dark
                            ? Colors.green
                            : Colors.green.shade700, // Light mode
                        size: 20,
                      ),
                      const SizedBox(width: 8),
                      Text(
                        'Download All Files',
                        style: AppTheme.titleStyle.copyWith(
                          color: Theme.of(context).brightness == Brightness.dark
                              ? Colors.green
                              : Colors.green.shade700, // Light mode
                          fontSize: 14,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  /// Extract links from post content - Enhanced
  List<String> _extractLinksFromContent() {
    final content = _currentPost.content;
    final links = <String>[];
    
    print('üîó DEBUG: Extracting links from content...');
    print('üîó DEBUG: Content length: ${content.length}');
    print('üîó DEBUG: Content preview: ${content.length > 200 ? content.substring(0, 200) : content}');
    
    // Enhanced regex to catch more URL patterns
    final urlPatterns = [
      // Standard HTTP/HTTPS URLs
      RegExp(r'''https?://[^\s<>"']+''', caseSensitive: false),
      // URLs without protocol but with www
      RegExp(r'''www\.[^\s<>"']+''', caseSensitive: false),
      // URLs with common domain patterns
      RegExp(r'''[a-zA-Z0-9.-]+\.(com|org|net|io|co|app|dev|ai|me|tv|info|biz|xyz)[^\s<>"']*''', caseSensitive: false),
    ];
    
    for (final pattern in urlPatterns) {
      final matches = pattern.allMatches(content);
      
      for (final match in matches) {
        String url = match.group(0)!;
        
        // Clean the URL
        url = _cleanExtractedUrl(url);
        
        // Add protocol if missing
        if (!url.startsWith('http') && url.startsWith('www.')) {
          url = 'https://$url';
        }
        
        // Only add if it's valid and not already in the list
        if (_isValidExtractedUrl(url) && !links.contains(url)) {
          links.add(url);
          print('üîó DEBUG: Found link: $url');
        }
      }
    }
    
    // Also check for common link patterns in HTML
    final htmlLinkPattern = RegExp(r'''href=["']([^"']+)["']''', caseSensitive: false);
    final htmlMatches = htmlLinkPattern.allMatches(content);
    
    for (final match in htmlMatches) {
      String url = match.group(1)!;
      
      // Skip relative URLs and anchors
      if (url.startsWith('#') || url.startsWith('/') || url.startsWith('mailto:')) {
        continue;
      }
      
      // Clean the URL
      url = _cleanExtractedUrl(url);
      
      // Add protocol if missing
      if (!url.startsWith('http') && url.startsWith('www.')) {
        url = 'https://$url';
      }
      
      // Only add if it's valid and not already in the list
      if (_isValidExtractedUrl(url) && !links.contains(url)) {
        links.add(url);
        print('üîó DEBUG: Found HTML link: $url');
      }
    }
    
    print('üîó DEBUG: Total links found: ${links.length}');
    for (int i = 0; i < links.length; i++) {
      print('üîó DEBUG: Link $i: ${links[i]}');
    }
    
    return links;
  }

  /// Clean extracted URL
  String _cleanExtractedUrl(String url) {
    // Remove trailing punctuation
    url = url.replaceAll(RegExp(r'[.,;:!?)\]}]+$'), '');
    
    // Remove HTML entities and artifacts
    url = url.replaceAll(RegExp(r'''["'\'>]'''), '');
    
    // Remove HTML closing tags
    url = url.replaceAll(RegExp(r'</[^>]*>$'), '');
    
    return url.trim();
  }

  /// Check if extracted URL is valid
  bool _isValidExtractedUrl(String url) {
    if (url.isEmpty) return false;
    
    // Check if it's a proper URL
    final uri = Uri.tryParse(url);
    if (uri == null || !uri.hasAbsolutePath) return false;
    
    // Check if it has a proper domain
    if (!url.contains('://') || url.length < 10) return false;
    
    // Check if it's not just a partial URL
    if (url.endsWith('.com') || url.endsWith('.org') || url.endsWith('.net')) {
      return false; // Incomplete URL
    }
    
    return true;
  }

  /// Copy link to clipboard
  void _copyLinkToClipboard(String link) async {
    try {
      await Clipboard.setData(ClipboardData(text: link));
      
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Link copied to clipboard!'),
          backgroundColor: Colors.green,
          behavior: SnackBarBehavior.floating,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(8),
          ),
        ),
      );
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Failed to copy link: $e'),
          backgroundColor: Colors.red,
          behavior: SnackBarBehavior.floating,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(8),
          ),
        ),
      );
    }
  }

  /// Open link in browser
  void _openLinkInBrowser(String link) async {
    try {
      final uri = Uri.parse(link);
      if (await canLaunchUrl(uri)) {
        await launchUrl(
          uri,
          mode: LaunchMode.externalApplication,
        );
        
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('Opening link in browser...'),
            backgroundColor: Colors.green,
            behavior: SnackBarBehavior.floating,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(8),
            ),
          ),
        );
      } else {
        throw Exception('Cannot launch browser');
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Failed to open browser: $e'),
          backgroundColor: Colors.red,
          behavior: SnackBarBehavior.floating,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(8),
          ),
        ),
      );
    }
  }

  /// Collect all downloadable items
  List<Map<String, dynamic>> _collectDownloadableItems() {
    final List<Map<String, dynamic>> downloadableItems = [];
    
    // Add files
    for (final file in _currentPost.file) {
      if (file.path != null && file.path!.isNotEmpty) {
        downloadableItems.add({
          'name': file.name,
          'url': file.path,
          'type': _getFileType(file.name),
          'size': 'Unknown',
        });
      }
    }
    
    // Add attachments
    for (final attachment in _currentPost.attachments) {
      if (attachment.path != null && attachment.path!.isNotEmpty) {
        downloadableItems.add({
          'name': attachment.name,
          'url': attachment.path,
          'type': _getFileType(attachment.name),
          'size': 'Unknown',
        });
      }
    }
    
    return downloadableItems;
  }

  /// Get file type from filename
  String _getFileType(String filename) {
    final extension = filename.toLowerCase().split('.').last;
    if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].contains(extension)) {
      return 'Image';
    } else if (['mp4', 'webm', 'mov', 'avi', 'mkv', 'flv'].contains(extension)) {
      return 'Video';
    } else if (['zip', 'rar', '7z', 'tar', 'gz'].contains(extension)) {
      return 'Archive';
    } else {
      return 'File';
    }
  }

  /// Build download item
  Widget _buildDownloadItem(Map<String, dynamic> item) {
    return Container(
      margin: const EdgeInsets.only(bottom: 8),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: Colors.grey.withOpacity(0.2)),
      ),
      child: ListTile(
        leading: Icon(
          _getFileIcon(item['type']),
          color: _getFileColor(item['type']),
        ),
        title: Text(
          item['name'],
          style: const TextStyle(
            fontSize: 14,
            fontWeight: FontWeight.w500,
          ),
          maxLines: 1,
          overflow: TextOverflow.ellipsis,
        ),
        subtitle: Text(
          '${item['type']} ‚Ä¢ ${item['size']}',
          style: TextStyle(
            fontSize: 12,
            color: Colors.grey[600],
          ),
        ),
        trailing: IconButton(
          icon: const Icon(Icons.download, size: 20),
          onPressed: () => _downloadSingleFile(item),
        ),
      ),
    );
  }

  /// Get file icon
  IconData _getFileIcon(String type) {
    switch (type) {
      case 'Image':
        return Icons.image;
      case 'Video':
        return Icons.videocam;
      case 'Archive':
        return Icons.archive;
      default:
        return Icons.insert_drive_file;
    }
  }

  /// Get file color
  Color _getFileColor(String type) {
    switch (type) {
      case 'Image':
        return Colors.blue;
      case 'Video':
        return Colors.red;
      case 'Archive':
        return Colors.orange;
      default:
        return Colors.grey;
    }
  }

  /// Build Post Content Section
  Widget _buildPostContent() {
    if (_currentPost.content.isEmpty) {
      return const SizedBox.shrink();
    }

    return Container(
      padding: const EdgeInsets.all(AppTheme.mdPadding),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Text(
            'Content',
            style: AppTheme.titleStyle.copyWith(
              color: AppTheme.getOnBackgroundColor(context),
              fontSize: 16,
              fontWeight: FontWeight.w600,
            ),
          ),
          const SizedBox(height: AppTheme.mdSpacing),
          
          // ‚úÖ DUAL METHOD: Content with Linkify (Method 1)
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: AppTheme.getSurfaceColor(context),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.grey.withOpacity(0.2)),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // Linkify content for inline clickable links
                Linkify(
                  text: _cleanHtmlContent(_currentPost.content),
                  style: TextStyle(
                    fontSize: 14,
                    color: AppTheme.getOnBackgroundColor(context),
                    height: 1.5,
                  ),
                  linkStyle: TextStyle(
                    color: AppTheme.primaryColor,
                    decoration: TextDecoration.underline,
                  ),
                  onOpen: (link) async {
                    final uri = Uri.parse(link.url);
                    if (await canLaunchUrl(uri)) {
                      await launchUrl(uri, mode: LaunchMode.externalApplication);
                    }
                  },
                ),
                
                // ‚úÖ NEW: Note about dedicated links section
                const SizedBox(height: 12),
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                  decoration: BoxDecoration(
                    color: Colors.green.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(6),
                    border: Border.all(color: Colors.green.withOpacity(0.3)),
                  ),
                  child: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      const Icon(
                        Icons.info_outline,
                        color: Colors.green,
                        size: 14,
                      ),
                      const SizedBox(width: 4),
                      const Text(
                        'All links extracted below for easy access',
                        style: TextStyle(
                          color: Colors.green,
                          fontSize: 11,
                          fontStyle: FontStyle.italic,
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  /// Build Tags Section dengan TagFilter integration
  Widget _buildTagsSection() {
    return Consumer<TagFilterProvider>(
      builder: (context, tagFilter, child) {
        return Container(
          padding: const EdgeInsets.all(AppTheme.mdPadding),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Section Title
              Text(
                'Tags',
                style: AppTheme.titleStyle.copyWith(
                  color: AppTheme.getOnBackgroundColor(context),
                  fontSize: 18,
                ),
              ),
              const SizedBox(height: AppTheme.mdSpacing),
              
              // Tags Wrap
              Wrap(
                spacing: 8,
                runSpacing: 8,
                children: _currentPost.tags.map((tag) {
                  final isBlocked = tagFilter.isTagBlocked(tag);
                  return ActionChip(
                    label: Text(
                      '#$tag',
                      style: AppTheme.captionStyle.copyWith(
                        color: isBlocked ? Colors.white : AppTheme.primaryColor,
                        fontWeight: FontWeight.w500,
                      ),
                    ),
                    backgroundColor: isBlocked ? AppTheme.errorColor : AppTheme.surfaceColor,
                    onPressed: () {
                      _handleTagTap(tag);
                    },
                    pressElevation: 2,
                    tooltip: isBlocked ? 'Blocked tag - Tap to search' : 'Tap to search for #$tag',
                  );
                }).toList(),
              ),
            ],
          ),
        );
      },
    );
  }

  /// Handle tag tap dengan search functionality
  void _handleTagTap(String tag) async {
    HapticFeedback.lightImpact();
    
    // Navigate to search dengan tag
    try {
      // TODO: Implement search navigation
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Searching for posts with tag: #$tag'),
          backgroundColor: AppTheme.primaryColor,
          action: SnackBarAction(
            label: 'Search',
            textColor: Colors.white,
            onPressed: () {
              // TODO: Navigate to search screen
            },
          ),
        ),
      );
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error searching for tag: $e'),
          backgroundColor: AppTheme.errorColor,
        ),
      );
    }
  }

  /// Build Comments Section - Compact & Consistent Design
  Widget _buildCommentsSection() {
    return Container(
      padding: const EdgeInsets.all(AppTheme.mdPadding),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Compact Header
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                'Comments',
                style: AppTheme.titleStyle.copyWith(
                  color: AppTheme.getOnBackgroundColor(context),
                  fontSize: 16,
                  fontWeight: FontWeight.w600,
                ),
              ),
              Consumer<CommentsProvider>(
                builder: (context, commentsProvider, _) {
                  final comments = commentsProvider.comments;
                  final commentCount = comments.length;
                  
                  return TextButton(
                    onPressed: () {
                      print('üîç DEBUG: Opening comments for postId: ${_currentPost.id}, service: ${_currentPost.service}, creatorId: ${_currentPost.user}');
                      showModalBottomSheet(
                        context: context,
                        isScrollControlled: true,
                        builder: (context) => CommentsBottomSheet(
                          postId: _currentPost.id,
                          service: _currentPost.service,
                          creatorId: _currentPost.user,
                        ),
                      );
                    },
                    child: Text(
                      commentCount > 0 ? 'View All ($commentCount)' : 'View All',
                      style: TextStyle(
                        color: AppTheme.primaryColor,
                        fontSize: 12,
                        fontWeight: FontWeight.w500,
                      ),
                    ),
                  );
                },
              ),
            ],
          ),
          const SizedBox(height: 8), // Reduced spacing
          
          // Compact Comments Preview
          Consumer<CommentsProvider>(
            builder: (context, commentsProvider, _) {
              final comments = commentsProvider.comments;
              
              print('üîç DEBUG: Comments count in provider: ${comments.length}');
              print('üîç DEBUG: Comments provider state: ${commentsProvider.isLoading}');
              
              if (commentsProvider.isLoading) {
                return Container(
                  height: 60, // Fixed height for loading state
                  decoration: BoxDecoration(
                    color: AppTheme.getSurfaceColor(context),
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: Colors.grey.withOpacity(0.2)),
                  ),
                  child: const Center(
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        SizedBox(
                          width: 16,
                          height: 16,
                          child: CircularProgressIndicator(strokeWidth: 2),
                        ),
                        SizedBox(width: 8),
                        Text(
                          'Loading...',
                          style: TextStyle(fontSize: 12),
                        ),
                      ],
                    ),
                  ),
                );
              }
              
              if (comments.isEmpty) {
                return Container(
                  height: 60, // Fixed height for empty state
                  decoration: BoxDecoration(
                    color: AppTheme.getSurfaceColor(context),
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: Colors.grey.withOpacity(0.2)),
                  ),
                  child: Center(
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(
                          Icons.chat_bubble_outline,
                          color: Colors.grey[500],
                          size: 16,
                        ),
                        const SizedBox(width: 6),
                        Text(
                          'No comments yet',
                          style: TextStyle(
                            color: Colors.grey[500],
                            fontSize: 12,
                          ),
                        ),
                      ],
                    ),
                  ),
                );
              }
              
              // Compact comments preview - show only first 2
              return Column(
                children: [
                  // Show first 2 comments as compact preview
                  ...comments.take(2).map((comment) => _buildCompactCommentItem(comment)).toList(),
                  
                  // Compact "View more" indicator
                  if (comments.length > 2) ...[
                    const SizedBox(height: 4),
                    Container(
                      height: 30,
                      decoration: BoxDecoration(
                        color: AppTheme.getSurfaceColor(context),
                        borderRadius: BorderRadius.circular(6),
                        border: Border.all(color: Colors.grey.withOpacity(0.2)),
                      ),
                      child: Center(
                        child: Text(
                          '+${comments.length - 2} more comments',
                          style: TextStyle(
                            color: Colors.grey[600],
                            fontSize: 11,
                            fontStyle: FontStyle.italic,
                          ),
                        ),
                      ),
                    ),
                  ],
                ],
              );
            },
          ),
        ],
      ),
    );
  }

  /// Build compact comment item
  Widget _buildCompactCommentItem(comment) {
    return Container(
      margin: const EdgeInsets.only(bottom: 6), // Reduced margin
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 8), // Reduced padding
      decoration: BoxDecoration(
        color: AppTheme.getSurfaceColor(context),
        borderRadius: BorderRadius.circular(6), // Smaller radius
        border: Border.all(color: Colors.grey.withOpacity(0.2)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Compact author and date row
          Row(
            children: [
              Text(
                comment['author'] ?? 'Anonymous',
                style: const TextStyle(
                  fontSize: 11, // Smaller font
                  fontWeight: FontWeight.w600,
                  color: Colors.blue,
                ),
              ),
              const SizedBox(width: 8),
              Text(
                _formatCommentDate(comment['published'] ?? ''),
                style: TextStyle(
                  color: Colors.grey[500],
                  fontSize: 10, // Smaller font
                ),
              ),
            ],
          ),
          const SizedBox(height: 4), // Reduced spacing
          
          // Compact comment body
          Text(
            comment['body'] ?? '',
            style: TextStyle(
              fontSize: 12, // Smaller font
              color: AppTheme.getOnBackgroundColor(context),
              height: 1.3,
            ),
            maxLines: 2, // Limited to 2 lines
            overflow: TextOverflow.ellipsis,
          ),
        ],
      ),
    );
  }

  /// Format comment date
  String _formatCommentDate(String dateString) {
    try {
      final date = DateTime.parse(dateString);
      final now = DateTime.now();
      final difference = now.difference(date);
      
      if (difference.inMinutes < 1) {
        return 'just now';
      } else if (difference.inHours < 1) {
        return '${difference.inMinutes}m ago';
      } else if (difference.inDays < 1) {
        return '${difference.inHours}h ago';
      } else if (difference.inDays < 7) {
        return '${difference.inDays}d ago';
      } else {
        return '${date.day}/${date.month}/${date.year}';
      }
    } catch (e) {
      return dateString;
    }
  }

  /// Download all files
  Future<void> _downloadAllFiles() async {
    final downloadableItems = _collectDownloadableItems();
    
    if (downloadableItems.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('No files to download')),
      );
      return;
    }

    // Show progress
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(
        content: Row(
          children: [
            SizedBox(
              width: 20,
              height: 20,
              child: CircularProgressIndicator(
                strokeWidth: 2,
                valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
              ),
            ),
            SizedBox(width: 16),
            Text('Opening files in secure browser...'),
          ],
        ),
        duration: Duration(seconds: 10),
      ),
    );

    int successCount = 0;
    int failCount = 0;

    for (final item in downloadableItems) {
      try {
        final success = await _downloadSingleFile(item);
        if (success) {
          successCount++;
        } else {
          failCount++;
        }
        
        // Small delay between files
        await Future.delayed(const Duration(milliseconds: 500));
      } catch (e) {
        failCount++;
      }
    }

    // Show final result
    if (mounted) {
      ScaffoldMessenger.of(context).hideCurrentSnackBar();
      
      String message;
      Color backgroundColor;
      
      if (failCount == 0) {
        message = 'All $successCount files opened in secure browser';
        backgroundColor = Colors.green;
      } else if (successCount == 0) {
        message = 'Failed to open any files in browser';
        backgroundColor = Colors.red;
      } else {
        message = '$successCount opened, $failCount failed';
        backgroundColor = Colors.orange;
      }
      
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(message),
              const SizedBox(height: 4),
              const Text(
                'Close each browser tab when download completes',
                style: TextStyle(fontSize: 11, color: Colors.white70),
              ),
            ],
          ),
          backgroundColor: backgroundColor,
          duration: const Duration(seconds: 6),
        ),
      );
    }
  }

  /// Download single file
  Future<bool> _downloadSingleFile(Map<String, dynamic> item) async {
    try {
      final url = item['url'];
      final uri = Uri.parse(url);
      
      if (await canLaunchUrl(uri)) {
        await launchUrl(
          uri,
          mode: LaunchMode.externalApplication,
        );
        return true;
      }
      return false;
    } catch (e) {
      print('Error downloading file: $e');
      return false;
    }
  }

  /// Share post dengan clipboard
  Future<void> _sharePost() async {
    try {
      final postUrl = _getPostUrl();
      await Clipboard.setData(ClipboardData(text: postUrl));
      
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Post link copied to clipboard!'),
          backgroundColor: Colors.green,
        ),
      );
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Failed to share post: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  /// Get grid columns based on item count and state
  int _getGridColumns(int displayCount, int totalCount) {
    if (_showAllMedia) {
      // ‚úÖ FIX: Jangan terlalu banyak columns - biarkan gambar tetap besar
      if (displayCount <= 4) return 2;
      if (displayCount <= 9) return 2; // ‚úÖ Tetap 2 columns
      return 3; // ‚úÖ Max 3 columns, bukan 5
    } else {
      // Preview mode - max 3 columns
      if (displayCount <= 2) return 2;
      if (displayCount <= 4) return 2;
      return 3;
    }
  }

  /// Get media height untuk visual variety
  double _getMediaHeight(int index, int totalItems) {
    if (_showAllMedia) {
      // ‚úÖ FIX: Tinggi gambar yang lebih besar saat show all
      final heights = [180, 200, 190, 210, 195, 205, 185, 215, 220]; // ‚úÖ Lebih besar
      return heights[index % heights.length].toDouble();
    } else {
      // Preview heights
      final heights = [120, 140, 130, 150, 125, 135];
      return heights[index % heights.length].toDouble();
    }
  }

  /// Smart media item handler - bedakan video dan image
  void _openMediaItem(Map<String, dynamic> mediaItem, int index, bool isVideo) {
    if (isVideo) {
      // Open video player
      Navigator.push(
        context,
        MaterialPageRoute(
          builder: (context) => VideoPlayerScreen(
            videoUrl: mediaItem['url'],
            videoName: mediaItem['name'] ?? 'Video',
            apiSource: widget.apiSource.name,
          ),
        ),
      );
    } else {
      // Open fullscreen image viewer
      Navigator.push(
        context,
        MaterialPageRoute(
          builder: (context) => FullscreenMediaViewer(
            mediaItems: [{
              'type': 'image',
              'url': mediaItem['url'],
              'name': mediaItem['name'],
            }],
            initialIndex: 0,
            apiSource: widget.apiSource,
          ),
        ),
      );
    }
  }

  /// Open fullscreen viewer untuk individual image
  void _openFullscreenViewer(int initialIndex) {
    // Collect all media items for proper indexing
    final allMediaItems = _collectAndSortMedia();
    
    if (allMediaItems.isEmpty) return;

    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => FullscreenMediaViewer(
          mediaItems: allMediaItems,
          initialIndex: initialIndex,
          apiSource: widget.apiSource,
        ),
      ),
    );
  }

  /// Get original URL dengan CDN rotation
  String _getOriginalUrl(String url, String apiSource) {
    String domain;
    
    if (_currentPost.service == 'onlyfans' || 
        _currentPost.service == 'fansly' || 
        _currentPost.service == 'candfans') {
      // Use CDN rotation for Coomer reliability
      domain = 'https://n2.coomer.st'; // Primary CDN
    } else {
      domain = 'https://kemono.cr'; // Kemono services
    }
    
    // Extract path dari URL
    final uri = Uri.parse(url);
    final path = uri.path;
    
    return '$domain$path';
  }

  /// Toggle bookmark dengan haptic feedback
  Future<void> _toggleBookmark() async {
    try {
      final postsProvider = context.read<PostsProvider>();
      final wasSaved = _currentPost.saved;
      
      // Show immediate visual feedback
      HapticFeedback.lightImpact();
      
      // Show loading indicator
      ScaffoldMessenger.of(context).hideCurrentSnackBar();
      
      await postsProvider.toggleSavePost(_currentPost);
      
      // Show success message with visual indication
      final message = wasSaved ? 'Post removed from saved' : 'Post saved successfully!';
      final backgroundColor = wasSaved ? Colors.orange : Colors.green;
      
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Row(
            children: [
              Icon(
                wasSaved ? Icons.bookmark_border : Icons.bookmark,
                color: Colors.white,
                size: 20,
              ),
              const SizedBox(width: 12),
              Text(message),
            ],
          ),
          backgroundColor: backgroundColor,
          duration: const Duration(seconds: 2),
        ),
      );
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error toggling bookmark: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  /// Build optimized image - ORIGINAL RESOLUTION & NO STRETCH!
  Widget _buildOptimizedImage(String imageUrl, {String? thumbnailUrl}) {
    // ‚úÖ USE THUMBNAIL LIKE BROKEN2 (fast di 300KB/d!)
    final displayUrl = thumbnailUrl ?? imageUrl;
    final hasThumbnail = thumbnailUrl != null && thumbnailUrl.isNotEmpty;
    
    print('üîç DEBUG: === IMAGE LOADING ANALYSIS ===');
    print('üîç DEBUG: Display URL: $displayUrl');
    print('üîç DEBUG: Has thumbnail: $hasThumbnail');
    print('üîç DEBUG: Thumbnail URL: $thumbnailUrl');
    print('üîç DEBUG: Full URL: $imageUrl');
    print('üîç DEBUG: Cache: ${hasThumbnail ? 'Thumbnail (smaller)' : 'Full resolution'}');
    
    // ‚úÖ BANDWIDTH ANALYSIS
    if (hasThumbnail) {
      print('üîç DEBUG: Using THUMBNAIL for preview, full resolution on tap');
      print('üîç DEBUG: Expected bandwidth: 42 images √ó 20KB = 840KB total');
    } else {
      print('üîç DEBUG: Using FULL IMAGE (original resolution!)');
      print('üîç DEBUG: Expected bandwidth: 42 images √ó 80KB = 3.36MB total');
    }
    print('üîç DEBUG: === END ANALYSIS ===');
    
    return CachedNetworkImage(
      imageUrl: displayUrl,
      // ‚úÖ NO STRETCH - Use original aspect ratio!
      fit: BoxFit.contain, // Preserve aspect ratio, no crop/stretch
      placeholder: (context, url) => Container(
        color: Colors.grey[300],
        child: const Center(
          child: CircularProgressIndicator(strokeWidth: 2),
        ),
      ),
      errorWidget: (context, url, error) {
        print('üîç DEBUG: Image load error: $error for URL: $url');
        
        // ‚úÖ FALLBACK TO FULL IMAGE (like broken2)
        if (hasThumbnail && url == thumbnailUrl) {
          print('üîç DEBUG: FALLBACK - Thumbnail failed, using full image');
          print('üîç DEBUG: Fallback URL: $imageUrl');
          print('üîç DEBUG: Fallback: Original resolution');
          return CachedNetworkImage(
            imageUrl: imageUrl,
            fit: BoxFit.contain, // ‚úÖ NO STRETCH
            placeholder: (context, url) => Container(
              color: Colors.grey[300],
              child: const Center(
                child: CircularProgressIndicator(strokeWidth: 2),
              ),
            ),
            errorWidget: (context, url, error) => Container(
              color: Colors.grey[300],
              child: const Center(
                child: Icon(Icons.broken_image, color: Colors.grey),
              ),
            ),
            // ‚úÖ NO CACHE LIMIT - Full resolution!
          );
        }
        
        return Container(
          color: Colors.grey[300],
          child: const Center(
            child: Icon(Icons.broken_image, color: Colors.grey),
          ),
        );
      },
      // ‚úÖ SMART CACHING - Thumbnail cache, full resolution display
      memCacheWidth: hasThumbnail ? 400 : null,   // Thumbnail cache, full res display
      memCacheHeight: hasThumbnail ? 400 : null,  // Thumbnail cache, full res display
    );
  }

  /// Get post URL
  String _getPostUrl() {
    final domain = widget.apiSource == ApiSource.kemono 
        ? 'kemono.party' 
        : 'coomer.party';
    return 'https://$domain/${widget.post.service}/user/${widget.post.user}/post/${widget.post.id}';
  }
}